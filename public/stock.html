<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartDent ERP — Stock Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .modal { @apply fixed inset-0 flex items-center justify-center hidden z-50; }
    .modal-content { @apply bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-lg font-semibold">SmartDent ERP — Stock Management</h1>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">

    <!-- Stock Analytics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500">Total Items</p>
        <p id="totalItems" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500">Total Quantity</p>
        <p id="totalQuantity" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <p class="text-gray-500">Low Stock Items</p>
        <p id="lowStock" class="text-2xl font-bold">0</p>
      </div>
    </div>

    <!-- Stock Chart -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <canvas id="stockChart" class="w-full h-64"></canvas>
    </div>

    <!-- Stock Table -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="font-semibold text-lg mb-4">Stock Table</h2>
      <table class="w-full table-auto border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="border px-3 py-2">Item</th>
            <th class="border px-3 py-2">Quantity</th>
            <th class="border px-3 py-2">Reorder Level</th>
            <th class="border px-3 py-2">Actions</th>
          </tr>
        </thead>
        <tbody id="stockTableBody"></tbody>
      </table>
    </div>

    <!-- Supplier & New Order -->
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <h2 class="font-semibold text-lg mb-4">Place New Stock Order</h2>
      <form id="newOrderForm" class="space-y-3">
        <select id="supplierSelect" class="w-full border rounded p-2" required>
          <option value="">Select Supplier</option>
        </select>
        <input type="text" id="orderItem" placeholder="Item Name" class="w-full border rounded p-2" required />
        <input type="number" id="orderQuantity" placeholder="Quantity" class="w-full border rounded p-2" required />
        <input type="number" id="orderPrice" placeholder="Price per Unit" class="w-full border rounded p-2" required />
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Place Order</button>
      </form>
    </div>

  </main>

  <!-- Deduct Stock Modal -->
  <div id="deductModal" class="modal">
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-4">Deduct Stock for Service</h2>
      <button onclick="closeModal('deductModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">&times;</button>
      <form id="deductForm" class="space-y-3">
        <p id="deductItemName" class="font-semibold"></p>
        <input type="number" id="deductQuantity" placeholder="Quantity Used" class="w-full border rounded p-2" required />
        <input type="text" id="deductService" placeholder="Service/Usage Description" class="w-full border rounded p-2" />
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Deduct Stock</button>
      </form>
    </div>
  </div>

<script>
  const clinic_id = 'clinic_001';
  let stockData = [];
  let selectedStockId = null;

  // ==============================
  // Fetch stock and analytics
  // ==============================
  async function fetchStock() {
    const res = await fetch(`/api/stock?type=stock&clinic_id=${clinic_id}`);
    const json = await res.json();
    stockData = json.data || [];
    renderTable();
    renderChart();
  }

  async function fetchAnalytics() {
    const res = await fetch(`/api/stock?type=analytics&clinic_id=${clinic_id}`);
    const data = await res.json();
    document.getElementById('totalItems').textContent = data.total_items || 0;
    document.getElementById('totalQuantity').textContent = data.total_quantity || 0;
    document.getElementById('lowStock').textContent = data.low_stock || 0;
  }

  // ==============================
  // Render stock table
  // ==============================
  function renderTable() {
    const tbody = document.getElementById('stockTableBody');
    tbody.innerHTML = '';
    stockData.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-3 py-2">${item.name}</td>
        <td class="border px-3 py-2">${item.quantity}</td>
        <td class="border px-3 py-2">${item.reorder_level}</td>
        <td class="border px-3 py-2">
          <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="openDeductModal('${item.stock_id}', '${item.name}')">Deduct</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ==============================
  // Stock chart
  // ==============================
  const chartCtx = document.getElementById('stockChart').getContext('2d');
  let stockChart = null;
  function renderChart() {
    const labels = stockData.map(s => s.name);
    const quantities = stockData.map(s => s.quantity);
    if (stockChart) stockChart.destroy();
    stockChart = new Chart(chartCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Stock Quantity',
          data: quantities,
          backgroundColor: 'rgba(59, 130, 246, 0.7)',
          borderColor: 'rgba(59, 130, 246, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // ==============================
  // Fetch suppliers
  // ==============================
  async function fetchSuppliers() {
    const res = await fetch('/api/stock?type=suppliers');
    const { data } = await res.json();
    const select = document.getElementById('supplierSelect');
    select.innerHTML = '<option value="">Select Supplier</option>';
    data.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.supplier_id;
      opt.textContent = s.name;
      select.appendChild(opt);
    });
  }

  // ==============================
  // New Order Submission
  // ==============================
  document.getElementById('newOrderForm').addEventListener('submit', async e => {
    e.preventDefault();
    const supplier_id = document.getElementById('supplierSelect').value;
    const item = document.getElementById('orderItem').value;
    const quantity = parseInt(document.getElementById('orderQuantity').value);
    const price = parseFloat(document.getElementById('orderPrice').value);

    try {
      const res = await fetch('/api/stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ supplier_id, item, clinic_id, quantity, price })
      });
      if (!res.ok) throw new Error('Failed to place order');
      alert('✅ Order placed successfully');
      document.getElementById('newOrderForm').reset();
    } catch (err) {
      console.error(err);
      alert(`❌ ${err.message}`);
    }
  });

  // ==============================
  // Deduct stock modal
  // ==============================
  function openDeductModal(stock_id, name) {
    selectedStockId = stock_id;
    document.getElementById('deductItemName').textContent = name;
    document.getElementById('deductQuantity').value = '';
    document.getElementById('deductService').value = '';
    document.getElementById('deductModal').classList.remove('hidden');
  }

  function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
  }

  document.getElementById('deductForm').addEventListener('submit', async e => {
    e.preventDefault();
    const quantity_used = parseInt(document.getElementById('deductQuantity').value);
    const used_in_service = document.getElementById('deductService').value || 'General Use';

    try {
      const res = await fetch('/api/stock', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stock_id: selectedStockId, clinic_id, quantity_used, used_in_service })
      });
      if (!res.ok) throw new Error('Failed to deduct stock');
      alert('✅ Stock deducted successfully');
      closeModal('deductModal');
      await fetchStock();
      await fetchAnalytics();
    } catch (err) {
      console.error(err);
      alert(`❌ ${err.message}`);
    }
  });

  // ==============================
  // Initial load
  // ==============================
  fetchStock();
  fetchAnalytics();
  fetchSuppliers();
</script>

</body>
</html>

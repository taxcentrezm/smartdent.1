<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP — Stock & Suppliers</title>
 <style>
    .modal-center {
      display: none; position: fixed; inset: 0; z-index: 60;
      align-items: center; justify-content: center;
    }
    .modal-panel {
      width: 100%; max-width: 900px; background: white;
      border-radius: 12px; padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 50; display:none;
    }
    .small { max-width: 480px; }

    /* ✅ Chart container fix */
    .chart-container {
      position: relative;
      height: 320px;
      max-height: 360px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF for exports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* centered modal helpers */
    .modal-center { display: none; position: fixed; inset: 0; z-index: 60; align-items: center; justify-content: center; }
    .modal-panel { width: 100%; max-width: 900px; background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display:none; }
    .small { max-width: 480px; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-lg font-semibold">SmartDent ERP — Stock & Suppliers</h1>
      <div class="flex items-center gap-3">
        <button id="refreshBtn" class="bg-white text-indigo-700 px-3 py-1 rounded">Refresh</button>
      </div>
    </div>
  </header>

   <main class="container mx-auto px-4 py-6 space-y-6">

    <!-- Analytics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <div class="text-sm text-gray-500">Total Items</div>
        <div id="totalItems" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <div class="text-sm text-gray-500">Total Quantity</div>
        <div id="totalQuantity" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <div class="text-sm text-gray-500">Low Stock Items</div>
        <div id="lowStock" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded-xl shadow p-4 text-center">
        <div class="text-sm text-gray-500">Recent Usage (last 7 days)</div>
        <div id="recentUsageCount" class="text-2xl font-bold">0</div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <!-- Stock Levels Chart -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex justify-between items-center mb-3">
          <h2 class="font-semibold">Stock Levels</h2>
          <div class="text-sm text-gray-500">Live overview</div>
        </div>
        <div class="chart-container">
          <canvas id="stockChart"></canvas>
        </div>
      </div>

      <!-- Usage Chart -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex justify-between items-center mb-3">
          <h2 class="font-semibold">Recent Stock Usage</h2>
          <div class="text-sm text-gray-500">Last 30 entries</div>
        </div>
        <div class="chart-container">
          <canvas id="usageChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Stock Table -->
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-semibold">Stock Items</h2>
        <div class="flex gap-2">
          <button id="addStockBtn" class="bg-indigo-600 text-white px-3 py-1 rounded">Add Stock</button>
          <button id="viewSuppliersBtn" class="bg-green-600 text-white px-3 py-1 rounded">Suppliers</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full table-auto text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-2 border">Item</th>
              <th class="p-2 border">Quantity</th>
              <th class="p-2 border">Reorder Level</th>
              <th class="p-2 border">Clinic</th>
              <th class="p-2 border">Actions</th>
            </tr>
          </thead>
          <tbody id="stockTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Supplier Cards -->
    <div id="supplierCards" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

    <!-- Recent Usage Table -->
    <div class="bg-white rounded-xl shadow p-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="font-semibold">Recent Stock Usage</h2>
        <button id="exportUsagePdf" class="bg-indigo-600 text-white px-3 py-1 rounded">Export PDF</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-2 border">Date</th>
              <th class="p-2 border">Item</th>
              <th class="p-2 border">Quantity</th>
              <th class="p-2 border">Used By</th>
              <th class="p-2 border">Related To</th>
            </tr>
          </thead>
          <tbody id="usageTableBody"></tbody>
        </table>
      </div>
    </div>

  </main>

<!-- Overlay -->
  <div id="overlay" class="overlay"></div>

  <!-- Suppliers modal -->
  <div id="suppliersModal" class="modal-center">
    <div class="modal-panel small">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Suppliers & Supplies</h3>
        <button onclick="closeModal('suppliersModal')" class="text-gray-600">&times;</button>
      </div>
      <div id="suppliersList" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal-center">
    <div class="modal-panel">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Place New Order</h3>
        <button onclick="closeModal('orderModal')" class="text-gray-600">&times;</button>
      </div>

      <form id="orderForm" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <select id="orderSupplier" class="border p-2 rounded" required>
            <option value="">Select supplier</option>
          </select>

          <select id="orderSupplierItem" class="border p-2 rounded" required>
            <option value="">Select item</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
          <input id="orderQty" type="number" min="1" placeholder="Quantity" class="border p-2 rounded" required />
          <input id="orderUnit" placeholder="Unit (e.g., pcs, ml)" class="border p-2 rounded" />
          <input id="orderUnitPrice" type="number" min="0" step="0.01" placeholder="Price per unit" class="border p-2 rounded" required />
        </div>

        <div class="flex gap-2">
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Place Order</button>
          <button type="button" onclick="closeModal('orderModal')" class="px-4 py-2 rounded border">Cancel</button>
        </div>
        <div id="orderMsg" class="text-sm mt-1"></div>
      </form>
    </div>
  </div>

  <!-- Add stock modal -->
  <div id="addStockModal" class="modal-center">
    <div class="modal-panel small">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Add New Stock Item</h3>
        <button onclick="closeModal('addStockModal')" class="text-gray-600">&times;</button>
      </div>
      <form id="addStockForm" class="space-y-3">
        <input id="newStockName" placeholder="Item name" class="border p-2 rounded" required />
        <input id="newStockQty" type="number" min="0" placeholder="Quantity" class="border p-2 rounded" required />
        <input id="newStockReorder" type="number" min="0" placeholder="Reorder level" class="border p-2 rounded" value="10" required />
        <select id="newStockClinic" class="border p-2 rounded">
          <option value="clinic_001">Clinic 001</option>
        </select>
        <div class="flex gap-2">
          <button class="bg-indigo-600 text-white px-4 py-2 rounded" type="submit">Add</button>
          <button type="button" onclick="closeModal('addStockModal')" class="px-4 py-2 rounded border">Cancel</button>
        </div>
        <div id="addStockMsg" class="text-sm mt-1"></div>
      </form>
    </div>
  </div>

  <!-- Deduct modal -->
  <div id="deductModal" class="modal-center">
    <div class="modal-panel small">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Deduct Stock</h3>
        <button onclick="closeModal('deductModal')" class="text-gray-600">&times;</button>
      </div>

      <form id="deductForm" class="space-y-3">
        <div>
          <div id="deductItemLabel" class="font-semibold"></div>
          <input id="deductStockId" type="hidden" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input id="deductQty" type="number" min="1" placeholder="Quantity used" class="border p-2 rounded" required />
          <input id="deductUnit" placeholder="Unit (e.g., pcs, ml)" class="border p-2 rounded" />
        </div>

        <input id="deductPatient" placeholder="Patient ID (optional)" class="border p-2 rounded" />
        <input id="deductTreatment" placeholder="Treatment/Service (optional)" class="border p-2 rounded" />
        <div class="flex gap-2">
          <button class="bg-red-600 text-white px-4 py-2 rounded" type="submit">Deduct</button>
          <button type="button" onclick="closeModal('deductModal')" class="px-4 py-2 rounded border">Cancel</button>
        </div>
        <div id="deductMsg" class="text-sm mt-1"></div>
      </form>
    </div>
  </div>

<script>
const CLINIC_ID = 'clinic_001';

// ---------------- LOCAL STATE ----------------
let stockItems = [];
let suppliers = [];
let usageRecords = [];
let stockChart = null;
let usageChart = null;

// ---------------- UTILITIES ----------------
function openModal(id) {
  document.getElementById('overlay').style.display = 'block';
  const m = document.getElementById(id);
  if (m) m.style.display = 'flex';
}
function closeModal(id) {
  document.getElementById('overlay').style.display = 'none';
  const m = document.getElementById(id);
  if (m) m.style.display = 'none';
  ['orderMsg','addStockMsg','deductMsg'].forEach(i=>{
    const el=document.getElementById(i);
    if(el) el.textContent='';
  });
}
function escapeHtml(s) {
  if(!s && s!==0) return '';
  return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// ---------------- FETCH FUNCTIONS ----------------
async function fetchStock() {
  try {
    const res = await fetch(`/api/stock?type=stock&clinic_id=${CLINIC_ID}`);
    if(!res.ok) throw new Error('Failed to fetch stock');
    const json = await res.json();
    stockItems = Array.isArray(json.data)?json.data:json.data||[];
    renderStockTable();
    renderStockChart();
  } catch(err){ console.error('❌ fetchStock error:', err); }
}

async function fetchAnalytics() {
  try {
    const res = await fetch(`/api/stock?type=analytics&clinic_id=${CLINIC_ID}`);
    if(!res.ok) throw new Error('Failed to fetch analytics');
    const a = await res.json();
    document.getElementById('totalItems').textContent = a.total_items ?? stockItems.length;
    document.getElementById('totalQuantity').textContent = a.total_quantity ?? stockItems.reduce((s,i)=>s+(i.quantity||0),0);
    document.getElementById('lowStock').textContent = a.low_stock ?? stockItems.filter(i=>(i.quantity||0)<=(i.reorder_level||10)).length;
  } catch(err){ console.error('❌ fetchAnalytics error:', err); }
}

async function fetchSuppliers() {
  try {
    const res = await fetch('/api/stock?type=suppliers');
    if(!res.ok) throw new Error('Failed to fetch suppliers');
    const json = await res.json();
    suppliers = Array.isArray(json.data)?json.data:json.data||[];
    renderSupplierCards();
    populateOrderSupplierDropdown();
  } catch(err){ console.error('❌ fetchSuppliers error:', err); }
}

async function fetchUsage(limit=30) {
  try {
    const res = await fetch(`/api/stock?type=usage&clinic_id=${CLINIC_ID}&limit=${limit}`);
    if(!res.ok) throw new Error('Failed to fetch usage');
    const json = await res.json();
    usageRecords = Array.isArray(json.data)?json.data:json.data||[];
    renderUsageTable();
    renderUsageChart();
    document.getElementById('recentUsageCount').textContent = usageRecords.length;
  } catch(err){ console.error('❌ fetchUsage error:', err); }
}

// ---------------- RENDER FUNCTIONS ----------------
function renderStockTable() {
  const tbody = document.getElementById('stockTableBody');
  tbody.innerHTML = '';
  stockItems.forEach(item=>{
    const tr = document.createElement('tr');
    const lowClass = (item.quantity <= (item.reorder_level||10))?'text-rose-600 font-semibold':'';
    tr.innerHTML=`
      <td class="p-2 border">${escapeHtml(item.name)}</td>
      <td class="p-2 border ${lowClass}">${item.quantity}</td>
      <td class="p-2 border">${item.reorder_level ?? 10}</td>
      <td class="p-2 border">${escapeHtml(item.clinic_id||'')}</td>
      <td class="p-2 border">
        <div class="flex gap-2">
          <button class="px-2 py-1 bg-red-600 text-white rounded text-sm" onclick="openDeductModal('${escapeHtml(item.stock_id)}','${escapeHtml(item.name)}')">Deduct</button>
          <button class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm" onclick="openOrderForItem('${escapeHtml(item.name)}')">Order More</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function renderSupplierCards() {
  const container = document.getElementById('supplierCards');
  container.innerHTML = '';
  suppliers.forEach(s=>{
    const div = document.createElement('div');
    div.className='bg-white rounded-xl shadow p-4';
    div.innerHTML=`
      <div class="flex justify-between items-start">
        <div>
          <div class="font-semibold">${escapeHtml(s.name)}</div>
          <div class="text-xs text-gray-500">${escapeHtml(s.contact||'')}</div>
        </div>
        <div class="text-right">
          <button class="bg-indigo-600 text-white px-3 py-1 rounded text-sm" onclick="openSuppliesModal('${escapeHtml(s.supplier_id)}')">View Supplies</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

function populateOrderSupplierDropdown() {
  const sel = document.getElementById('orderSupplier');
  sel.innerHTML='<option value="">Select supplier</option>';
  suppliers.forEach(s=>{
    const opt=document.createElement('option');
    opt.value=s.supplier_id;
    opt.textContent=s.name;
    sel.appendChild(opt);
  });
}

// ---------------- MODAL LOGIC ----------------
function openSuppliesModal(supplier_id){
  const s=suppliers.find(x=>x.supplier_id===supplier_id);
  const list=document.getElementById('suppliersList');
  if(!s){ list.innerHTML='<div class="text-red-500">Supplier not found</div>'; } 
  else {
    list.innerHTML=`
      <div class="mb-2 font-semibold">${escapeHtml(s.name)}</div>
      <div class="text-sm text-gray-500 mb-3">${escapeHtml(s.contact||'')}</div>
      <div class="space-y-2">
        ${(s.supplies||[]).map(sp=>`
          <div class="p-2 border rounded flex justify-between items-center">
            <div>
              <div class="font-medium">${escapeHtml(sp.name)}</div>
              <div class="text-xs text-gray-500">${escapeHtml(sp.sku||'')} ${sp.unit?'• '+sp.unit:''}</div>
            </div>
            <div class="text-right">
              <div class="font-semibold">$${sp.price ?? 'N/A'}</div>
              <div class="text-xs text-gray-500">MOQ: ${sp.moq ?? '1'}</div>
            </div>
          </div>`).join('')}
      </div>
    `;
  }
  openModal('suppliersModal');
}

function openOrderForItem(itemName){
  openModal('orderModal');
  const optName=document.getElementById('orderItemName');
  if(!optName){
    const input=document.createElement('input');
    input.id='orderItemName'; input.type='hidden'; input.value=itemName;
    document.getElementById('orderForm').appendChild(input);
  } else { optName.value=itemName; }
}

function openDeductModal(stock_id,itemName){
  document.getElementById('deductItemLabel').textContent=itemName;
  document.getElementById('deductStockId').value=stock_id;
  document.getElementById('deductQty').value=1;
  document.getElementById('deductUnit').value='';
  document.getElementById('deductPatient').value='';
  document.getElementById('deductTreatment').value='';
  document.getElementById('deductMsg').textContent='';
  openModal('deductModal');
}

// ---------------- CHARTS ----------------
function renderStockChart(){
  const ctx = document.getElementById('stockChart').getContext('2d');
  const labels=stockItems.map(i=>i.name);
  const data=stockItems.map(i=>i.quantity||0);
  if(stockChart) stockChart.destroy();
  stockChart=new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Quantity', data, backgroundColor:'rgba(59,130,246,0.6)', borderColor:'rgba(59,130,246,1)', borderWidth:1 }]}, options:{ responsive:true, maintainAspectRatio:true, aspectRatio:2, scales:{y:{beginAtZero:true}}, plugins:{legend:{display:false}} } });
}

function renderUsageChart(){
  const ctx=document.getElementById('usageChart').getContext('2d');
  const map={};
  usageRecords.forEach(r=>{
    const name=r.item_name||r.name||'Unknown';
    map[name]=(map[name]||0)+(r.quantity_used||r.quantity||0);
  });
  const labels=Object.keys(map).slice(0,12);
  const data=labels.map(l=>map[l]);
  if(usageChart) usageChart.destroy();
  usageChart=new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ label:'Used', data, borderColor:'rgba(239,68,68,0.8)', backgroundColor:'rgba(239,68,68,0.15)', borderWidth:2, fill:true, tension:0.4 }]}, options:{ responsive:true, maintainAspectRatio:true, aspectRatio:2, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
}

// ---------------- USAGE TABLE ----------------
function renderUsageTable(){
  const tbody=document.getElementById('usageTableBody');
  tbody.innerHTML='';
  usageRecords.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="p-2 border">${u.created_at||'N/A'}</td>
      <td class="p-2 border">${escapeHtml(u.item_name||u.name||'N/A')}</td>
      <td class="p-2 border">${u.quantity_used??u.quantity??0}</td>
      <td class="p-2 border">${escapeHtml(u.patient_id||u.used_by||'—')}</td>
      <td class="p-2 border">${escapeHtml(u.related_to||u.treatment_id||u.invoice_id||'—')}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------------- DEDUCT FORM ----------------
document.getElementById('deductForm').addEventListener('submit', async(ev)=>{
  ev.preventDefault();
  const stock_id=document.getElementById('deductStockId').value;
  const quantity_used=parseInt(document.getElementById('deductQty').value);
  const unit=document.getElementById('deductUnit').value;
  const patient_id=document.getElementById('deductPatient').value||null;
  const treatment_id=document.getElementById('deductTreatment').value||null;
  const msgEl=document.getElementById('deductMsg');

  try{
    const res=await fetch('/api/stock',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action:'deduct',
        item_id:stock_id,
        quantity_used,
        used_by:patient_id||'system',
        related_to:treatment_id||'invoice',
        clinic_id:CLINIC_ID
      })
    });
    if(!res.ok){
      const err=await res.json().catch(()=>({error:'Deduct failed'}));
      throw new Error(err.error||'Deduct failed');
    }
    msgEl.textContent='✅ Deducted';
    await Promise.all([fetchStock(), fetchUsage(), fetchAnalytics()]);
    setTimeout(()=>closeModal('deductModal'),700);
  } catch(err){
    console.error('❌ deduct error', err);
    msgEl.textContent=`❌ ${err.message}`;
  }
});

// ---------------- INITIAL LOAD ----------------
(async function init(){
  await Promise.all([fetchStock(), fetchSuppliers(), fetchAnalytics(), fetchUsage(50)]);
})();
</script>


</body>
</html>

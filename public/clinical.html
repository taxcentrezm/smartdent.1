<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP ‚Äî Clinical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .tab-active { @apply border-b-2 border-indigo-600 text-indigo-600 font-semibold; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">

  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v6"></path><path d="M8 10s1 2 4 2 4-2 4-2"></path><path d="M6 21s2-4 6-4 6 4 6 4"></path>
          </svg>
        </div>
        <div class="font-semibold text-lg">SmartDent ERP</div>
      </div>
      <div class="flex items-center gap-3">
        <button class="bg-white/90 text-indigo-600 px-3 py-2 rounded-md inline-flex items-center gap-2 shadow-sm">
          <i data-feather="clipboard"></i> Clinical Tools
        </button>
        <div class="relative">
          <button class="flex items-center gap-2 bg-white/90 px-3 py-2 rounded-full shadow-sm">
            <img src="assets/images/avatar(1).jpg" class="w-8 h-8 rounded-full object-cover">
            <span class="hidden md:inline-block text-sm">Dr._____</span>
            <i data-feather="chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  

  <main class="container mx-auto px-4 py-6">
    <div class="card space-y-4">

      <!-- Patient Selection -->

      <!-- Tabs -->
      <div class="flex gap-6 border-b mb-4 text-sm">
        <button class="tab-active" onclick="showTab('charting')">Charting</button>
        <button onclick="showTab('imaging')">Imaging</button>
        <button onclick="showTab('prescriptions')">Prescriptions</button>
      </div>

      <!-- Charting -->
      <div id="charting" class="space-y-4">
        <h2 class="text-lg font-semibold">Dental Charting</h2>
        <textarea id="chartNotes" class="w-full border rounded-md p-2" rows="4" placeholder="Charting notes‚Ä¶"></textarea>
        <button onclick="saveClinicalRecord()" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save Chart</button>
      </div>

      <!-- Imaging -->
      <div id="imaging" class="space-y-4 hidden">
        <h2 class="text-lg font-semibold">Imaging</h2>
        <input id="imagingInput" type="file" multiple class="border rounded-md p-2" />
        <div id="imagingPreview" class="grid grid-cols-2 gap-4 mt-4"></div>
      </div>

      <!-- Prescriptions -->
      <div id="prescriptions" class="space-y-4 hidden">
        <h2 class="text-lg font-semibold">Prescriptions</h2>
        <ul class="space-y-3 text-sm" id="prescriptionList"></ul>
        <div class="flex gap-2">
          <input id="medInput" type="text" placeholder="Medication" class="flex-1 px-3 py-2 border rounded-md" />
          <button onclick="addPrescription()" class="px-4 py-2 bg-green-600 text-white rounded-md">Add</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="mt-8 text-sm text-gray-500 text-center">
    SmartDent ERP ‚Ä¢ Clinical Records & Tools
  </footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
feather.replace();

const patientsDropdown = document.createElement('select');
patientsDropdown.id = 'patientSelect';
patientsDropdown.className = 'border rounded-md p-2 w-full mb-4';

const clinicalContainer = document.getElementById('charting'); // main container for charting notes
let currentPatientId = null;
let clinicalRecords = [];
const prescriptions = [];

// ================================
// Load patients from DB
// ================================
async function loadPatients() {
  try {
    const res = await fetch('/api/patients');
    const data = await res.json();
    if (!data.data) return;

    data.data.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.patient_id;
      opt.textContent = `${p.full_name} (${p.phone})`;
      patientsDropdown.appendChild(opt);
    });

    patientsDropdown.addEventListener('change', () => {
      currentPatientId = patientsDropdown.value;
      loadClinicalRecords(currentPatientId);
    });

    document.querySelector('main').prepend(patientsDropdown);
    currentPatientId = patientsDropdown.value;
    loadClinicalRecords(currentPatientId);

  } catch (err) {
    console.error('‚ùå Failed to load patients:', err);
  }
}

// ================================
// Load clinical records for a patient
// ================================
async function loadClinicalRecords(patientId) {
  if (!patientId) return;

  currentPatientId = patientId;

  try {
    const res = await fetch(`/api/integrations?type=clinical&patient_id=${patientId}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    clinicalRecords = data.data || data.rows || [];


    console.log(`üí° Fetched ${clinicalRecords.length} clinical records for patient ${patientId}`);

    if (!clinicalContainer.querySelector('textarea')) {
      clinicalContainer.innerHTML = `<textarea class="border rounded w-full p-2" rows="6"></textarea>`;
    }

    if (clinicalRecords.length === 0) {
      clinicalContainer.querySelector('textarea').value = '';
      clinicalContainer.innerHTML += '<p class="text-gray-500">No clinical records found.</p>';
    } else {
      // Prefill with the latest visit (first in the sorted array)
      clinicalData = clinicalRecords[0];
      clinicalContainer.querySelector('textarea').value = clinicalData.charting || '';
      renderPrescriptions();
    }

  } catch (err) {
    console.log("üßæ Raw clinical response:", data);
    console.error('‚ùå Failed to load clinical records:', err);
    clinicalContainer.innerHTML = '<p class="text-red-500">Failed to load clinical records.</p>';
  }
}


// ================================
// Render charting notes and prescriptions
// ================================
function renderClinicalRecords(record) {
  // Ensure a textarea exists
  let chartingTextarea = clinicalContainer.querySelector('textarea');
  if (!chartingTextarea) {
    chartingTextarea = document.createElement('textarea');
    chartingTextarea.className = 'border w-full rounded p-2 mb-4';
    chartingTextarea.rows = 6;
    clinicalContainer.appendChild(chartingTextarea);
  }
  chartingTextarea.value = record.charting || '';

  // Render prescriptions
  prescriptions.length = 0;
  if (record.prescriptions) {
    try {
      // Handle CSV-style or JSON-style strings
      const parsed = record.prescriptions.startsWith('[') ? JSON.parse(record.prescriptions) :
                     record.prescriptions.split(',').map(p => ({ name: p.trim(), dosage: '‚Äî' }));
      parsed.forEach(p => prescriptions.push(p));
    } catch {}
  }
  renderPrescriptions();
}

function renderPrescriptions(){
  let ul = document.getElementById('prescriptionList');
  if (!ul) {
    ul = document.createElement('ul');
    ul.id = 'prescriptionList';
    ul.className = 'mb-4';
    clinicalContainer.appendChild(ul);
  }
  ul.innerHTML = '';
  prescriptions.forEach(p => {
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center';
    li.innerHTML = `<div>${p.name} ‚Äî <span class="text-gray-500">${p.dosage}</span></div>
                    <button onclick="removePrescription('${p.name}')" class="text-rose-600"><i data-feather="x"></i></button>`;
    ul.appendChild(li);
  });
  feather.replace();
}

function addPrescription(){
  const med = document.getElementById('medInput').value.trim();
  if(!med) return;
  prescriptions.push({ name: med, dosage: '‚Äî' });
  document.getElementById('medInput').value = '';
  renderPrescriptions();
}

function removePrescription(name){
  const idx = prescriptions.findIndex(p => p.name === name);
  if(idx !== -1) prescriptions.splice(idx, 1);
  renderPrescriptions();
}

// ================================
// Save clinical record
// ================================
async function saveClinicalRecord() {
  if (!currentPatientId) return alert('‚ö†Ô∏è Please select a patient first.');
  const charting = clinicalContainer.querySelector('textarea').value;

  try {
    const res = await fetch(`/api/integrations?type=clinical`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        patient_id: currentPatientId,
        charting: charting,
        prescriptions: prescriptions,
        imaging: [],
        notes: ''
      })
    });

    if (!res.ok) {
      const errData = await res.json().catch(()=>({}));
      throw new Error(errData.error || 'Failed to save clinical record.');
    }

    alert('‚úÖ Clinical record saved successfully!');
    loadClinicalRecords(currentPatientId);

  } catch (err) {
    console.error('‚ùå saveClinicalRecord error:', err);
    alert(`‚ùå ${err.message}`);
  }
}

// ================================
// Export patient records to PDF
// ================================
function exportPDF() {
  if (!clinicalRecords.length) {
    alert('No clinical records to export.');
    console.log('üí° No clinical records fetched for export.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text(`Clinical Records for Patient ${currentPatientId}`, 10, 10);

  clinicalRecords.forEach((rec, i) => {
    const y = 20 + i * 30;
    doc.setFontSize(12);
    doc.text(`Record ${i+1} (Created: ${rec.created_at})`, 10, y);
    doc.text(`Diagnosis: ${rec.diagnosis || 'N/A'}`, 10, y + 6);
    doc.text(`Charting: ${rec.charting || 'N/A'}`, 10, y + 12);
    doc.text(`Prescriptions: ${rec.prescriptions || 'N/A'}`, 10, y + 18);
    doc.text(`Notes: ${rec.notes || 'N/A'}`, 10, y + 24);
  });

  doc.save(`clinical_records_${currentPatientId}.pdf`);
  console.log(`üí° Exported ${clinicalRecords.length} records to PDF.`);
}

// ================================
// Tab switching
// ================================
window.showTab = function(id, event){
  ['charting','imaging','prescriptions'].forEach(tab => {
    const el = document.getElementById(tab);
    if(el) el.style.display = tab === id ? 'block' : 'none';
  });
  document.querySelectorAll('button').forEach(btn => btn.classList.remove('tab-active'));
  event.target.classList.add('tab-active');
}

// ================================
// Init
// ================================
document.addEventListener('DOMContentLoaded', () => {
  loadPatients();
  renderPrescriptions();

  // Add save/export buttons
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save Clinical Record';
  saveBtn.className = 'px-4 py-2 bg-indigo-600 text-white rounded-md';
  saveBtn.onclick = saveClinicalRecord;

  const exportBtn = document.createElement('button');
  exportBtn.textContent = 'Export PDF';
  exportBtn.className = 'px-4 py-2 bg-green-600 text-white rounded-md ml-2';
  exportBtn.onclick = exportPDF;

  clinicalContainer.appendChild(saveBtn);
  clinicalContainer.appendChild(exportBtn);
});
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP — Clinical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .tab-active { @apply border-b-2 border-indigo-600 text-indigo-600 font-semibold; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">

  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v6"></path><path d="M8 10s1 2 4 2 4-2 4-2"></path><path d="M6 21s2-4 6-4 6 4 6 4"></path>
          </svg>
        </div>
        <div class="font-semibold text-lg">SmartDent ERP</div>
      </div>
      <div class="flex items-center gap-3">
        <button class="bg-white/90 text-indigo-600 px-3 py-2 rounded-md inline-flex items-center gap-2 shadow-sm">
          <i data-feather="clipboard"></i> Clinical Tools
        </button>
        <div class="relative">
          <button class="flex items-center gap-2 bg-white/90 px-3 py-2 rounded-full shadow-sm">
            <img src="assets/images/avatar(1).jpg" class="w-8 h-8 rounded-full object-cover">
            <span class="hidden md:inline-block text-sm">Dr._____</span>
            <i data-feather="chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  

  <main class="container mx-auto px-4 py-6">
    <div class="card space-y-4">

      <!-- Patient Selection -->
      <div>
        <label class="block text-sm font-medium mb-2">Select Patient</label>
        <select id="patientSelect" class="w-full border rounded-md p-2"></select>
      </div>

      <!-- Tabs -->
      <div class="flex gap-6 border-b mb-4 text-sm">
        <button class="tab-active" onclick="showTab('charting')">Charting</button>
        <button onclick="showTab('imaging')">Imaging</button>
        <button onclick="showTab('prescriptions')">Prescriptions</button>
      </div>

      <!-- Charting -->
      <div id="charting" class="space-y-4">
        <h2 class="text-lg font-semibold">Dental Charting</h2>
        <textarea id="chartNotes" class="w-full border rounded-md p-2" rows="4" placeholder="Charting notes…"></textarea>
        <button onclick="saveClinicalRecord()" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save Chart</button>
      </div>

      <!-- Imaging -->
      <div id="imaging" class="space-y-4 hidden">
        <h2 class="text-lg font-semibold">Imaging</h2>
        <input id="imagingInput" type="file" multiple class="border rounded-md p-2" />
        <div id="imagingPreview" class="grid grid-cols-2 gap-4 mt-4"></div>
      </div>

      <!-- Prescriptions -->
      <div id="prescriptions" class="space-y-4 hidden">
        <h2 class="text-lg font-semibold">Prescriptions</h2>
        <ul class="space-y-3 text-sm" id="prescriptionList"></ul>
        <div class="flex gap-2">
          <input id="medInput" type="text" placeholder="Medication" class="flex-1 px-3 py-2 border rounded-md" />
          <button onclick="addPrescription()" class="px-4 py-2 bg-green-600 text-white rounded-md">Add</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="mt-8 text-sm text-gray-500 text-center">
    SmartDent ERP • Clinical Records & Tools
  </footer>

<script>
  feather.replace();

  const prescriptions = [];
  let selectedPatient = null;

  /* ==========================
     Load patients
  ========================== */
  async function loadPatients() {
    try {
      const res = await fetch("/api/patients");
      const data = await res.json();
      const select = document.getElementById("patientSelect") || document.createElement("select");
      select.id = "patientSelect";
      select.className = "border rounded-md px-3 py-2 w-full mb-4";
      select.innerHTML = `<option value="">-- Select Patient --</option>`;

      (data.data || []).forEach(p => {
        select.innerHTML += `<option value="${p.patient_id}">${p.full_name}</option>`;
      });

      select.onchange = e => {
        selectedPatient = e.target.value;
        if (selectedPatient) loadClinicalRecords(selectedPatient);
        else resetClinical();
      };

      const card = document.querySelector(".card");
      if (!document.getElementById("patientSelect")) {
        card.insertBefore(select, card.firstChild);
      }
    } catch (err) {
      console.error("❌ Failed to load patients:", err);
    }
  }

  /* ==========================
     Reset UI
  ========================== */
  function resetClinical() {
    document.getElementById("chartingNotes").value = "";
    prescriptions.length = 0;
    renderPrescriptions();
  }

  /* ==========================
     Fetch clinical records
  ========================== */
  async function loadClinicalRecords(patient_id) {
    try {
      const res = await fetch(`/api/integrations?type=clinical&patient_id=${patient_id}`);
      if (!res.ok) {
        console.warn("⚠️ No clinical data found for patient:", patient_id);
        resetClinical();
        return;
      }

      const records = await res.json();
      const latest = records[0] || {};
      document.getElementById("chartingNotes").value = latest.charting_notes || "";
      const meds = JSON.parse(latest.prescriptions || "[]");
      prescriptions.length = 0;
      prescriptions.push(...meds);
      renderPrescriptions();
    } catch (err) {
      console.error("❌ Failed to load clinical records:", err);
      resetClinical();
    }
  }

  /* ==========================
     Save clinical
  ========================== */
  async function saveClinical() {
    if (!selectedPatient) return alert("⚠️ Please select a patient first.");
    const notes = document.getElementById("chartingNotes").value.trim();

    const payload = {
      type: "clinical",
      patient_id: selectedPatient,
      charting_notes: notes,
      prescriptions: prescriptions
    };

    try {
      const res = await fetch("/api/integrations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Unknown error");
      alert("✅ Clinical record saved successfully!");
    } catch (err) {
      console.error("❌ Failed to save clinical:", err);
      alert("❌ Error: " + err.message);
    }
  }

  /* ==========================
     Prescriptions
  ========================== */
  function renderPrescriptions() {
    const ul = document.getElementById("prescriptionList");
    ul.innerHTML = "";
    prescriptions.forEach(p => {
      const li = document.createElement("li");
      li.className = "flex justify-between items-center";
      li.innerHTML = `<div>${p.name} — <span class="text-gray-500">${p.dosage || "—"}</span></div>
                      <button onclick="removePrescription('${p.name}')" class="text-rose-600"><i data-feather='x'></i></button>`;
      ul.appendChild(li);
    });
    feather.replace();
  }

  function addPrescription() {
    const med = document.getElementById("medInput").value.trim();
    if (!med) return;
    prescriptions.push({ name: med, dosage: "—" });
    document.getElementById("medInput").value = "";
    renderPrescriptions();
  }

  function removePrescription(name) {
    const idx = prescriptions.findIndex(p => p.name === name);
    if (idx !== -1) prescriptions.splice(idx, 1);
    renderPrescriptions();
  }

  /* ==========================
     Tabs
  ========================== */
  function showTab(id) {
    ["charting", "imaging", "prescriptions"].forEach(tab => {
      document.getElementById(tab).style.display = tab === id ? "block" : "none";
    });
    document.querySelectorAll(".tab-active").forEach(btn => btn.classList.remove("tab-active"));
    event.target.classList.add("tab-active");
  }

  /* ==========================
     Init
  ========================== */
  document.addEventListener("DOMContentLoaded", () => {
    feather.replace();

    // Ensure single charting notes exists
    if (!document.getElementById("chartingNotes")) {
      const textarea = document.createElement("textarea");
      textarea.id = "chartingNotes";
      textarea.className = "w-full border rounded-md p-2";
      textarea.rows = 4;
      textarea.placeholder = "Charting notes…";
      document.querySelector("#charting").appendChild(textarea);

      const saveBtn = document.querySelector("#charting button");
      saveBtn.onclick = saveClinical;
    }

    loadPatients();
    renderPrescriptions();
  });
</script>


</body>
</html>

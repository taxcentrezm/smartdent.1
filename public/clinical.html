<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP — Clinical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .tab-active { @apply border-b-2 border-indigo-600 text-indigo-600 font-semibold; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">

  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v6"></path><path d="M8 10s1 2 4 2 4-2 4-2"></path><path d="M6 21s2-4 6-4 6 4 6 4"></path>
          </svg>
        </div>
        <div class="font-semibold text-lg">SmartDent ERP</div>
      </div>
      <div class="flex items-center gap-3">
        <button class="bg-white/90 text-indigo-600 px-3 py-2 rounded-md inline-flex items-center gap-2 shadow-sm">
          <i data-feather="clipboard"></i> Clinical Tools
        </button>
        <div class="relative">
          <button class="flex items-center gap-2 bg-white/90 px-3 py-2 rounded-full shadow-sm">
            <img src="assets/images/avatar(1).jpg" class="w-8 h-8 rounded-full object-cover">
            <span class="hidden md:inline-block text-sm">Dr._____</span>
            <i data-feather="chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  

  <main class="container mx-auto px-4 py-6">
    <div class="card space-y-4">

    <!-- Buttons -->
<div class="my-4">
  <button id="newRecordBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Add New Clinical Record</button>
  <button id="viewRecordsBtn" class="px-4 py-2 bg-green-600 text-white rounded-md ml-2">View Patient Records</button>
</div>

<!-- New Clinical Record Modal -->
<div id="newRecordModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative">
    <h2 class="text-lg font-semibold mb-4">New Clinical Record</h2>
    <button class="absolute top-3 right-3 text-gray-500" onclick="closeModal('newRecordModal')">✖</button>

    <div class="mb-3">
      <label>Patient:</label>
      <select id="newPatientSelect" class="border rounded-md p-2 w-full"></select>
    </div>
    <div class="mb-3">
      <label>Patient Name:</label>
      <input type="text" id="newPatientName" class="border rounded-md p-2 w-full" readonly>
    </div>
    <div class="mb-3">
      <label>Age:</label>
      <input type="text" id="newPatientAge" class="border rounded-md p-2 w-full" readonly>
    </div>
    <div class="mb-3">
      <label>Patient ID:</label>
      <input type="text" id="newPatientId" class="border rounded-md p-2 w-full" readonly>
    </div>
    <div class="mb-3">
      <label>Phone Number:</label>
      <input type="text" id="newPatientPhone" class="border rounded-md p-2 w-full" readonly>
    </div>
    <div class="mb-3">
      <label>Clinic Name:</label>
      <input type="text" id="newClinicName" class="border rounded-md p-2 w-full" readonly>
    </div>
    <div class="mb-3">
      <label>Charting Notes:</label>
      <textarea id="newCharting" class="border rounded-md p-2 w-full h-24"></textarea>
    </div>
    <div class="mb-3">
      <label>Prescriptions (comma separated):</label>
      <input type="text" id="newPrescriptions" class="border rounded-md p-2 w-full">
    </div>
    <div class="mb-3">
      <label>Additional Notes:</label>
      <textarea id="newNotes" class="border rounded-md p-2 w-full h-16"></textarea>
    </div>

    <button class="px-4 py-2 bg-indigo-600 text-white rounded-md" onclick="saveNewClinicalRecord()">Save Record</button>
  </div>
</div>

<!-- View Patient Records Modal -->
<div id="viewRecordsModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl relative">
    <h2 class="text-lg font-semibold mb-4">Patient Clinical Records</h2>
    <button class="absolute top-3 right-3 text-gray-500" onclick="closeModal('viewRecordsModal')">✖</button>

    <div class="mb-3">
      <label>Select Patient:</label>
      <select id="recordsPatientSelect" class="border rounded-md p-2 w-full"></select>
    </div>

    <div id="patientRecordsContainer" class="mt-4 max-h-96 overflow-y-auto border p-3 rounded-md"></div>

    <button class="px-4 py-2 bg-green-600 text-white rounded-md mt-3" onclick="exportPatientRecordsPDF()">Export PDF</button>
  </div>
</div>
    </div>
  </main>

  <footer class="mt-8 text-sm text-gray-500 text-center">
    SmartDent ERP • Clinical Records & Tools
  </footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const newRecordModal = document.getElementById('newRecordModal');
const viewRecordsModal = document.getElementById('viewRecordsModal');

document.getElementById('newRecordBtn').addEventListener('click', () => {
  newRecordModal.classList.remove('hidden');
  loadPatientsDropdown();
});
document.getElementById('viewRecordsBtn').addEventListener('click', () => {
  viewRecordsModal.classList.remove('hidden');
  loadRecordsPatientsDropdown();
});

function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
}

// =============================
// Load patients for New Record
// =============================
async function loadPatientsDropdown() {
  const select = document.getElementById('newPatientSelect');
  select.innerHTML = '';
  try {
    const res = await fetch('/api/patients');
    const data = await res.json();
    if (!data.data) return;

    data.data.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.patient_id;
      opt.textContent = `${p.full_name} (${p.phone})`;
      opt.dataset.name = p.full_name;
      opt.dataset.age = p.age;
      opt.dataset.phone = p.phone;
      opt.dataset.clinic = p.clinic_name || 'Clinic';
      select.appendChild(opt);
    });

    select.addEventListener('change', () => {
      const opt = select.selectedOptions[0];
      document.getElementById('newPatientName').value = opt.dataset.name;
      document.getElementById('newPatientAge').value = opt.dataset.age;
      document.getElementById('newPatientId').value = opt.value;
      document.getElementById('newPatientPhone').value = opt.dataset.phone;
      document.getElementById('newClinicName').value = opt.dataset.clinic;
    });

    // trigger first selection
    select.dispatchEvent(new Event('change'));
  } catch (err) {
    console.error('Failed to load patients:', err);
  }
}

// =============================
// Save new clinical record
// =============================
async function saveNewClinicalRecord() {
  const patient_id = document.getElementById('newPatientId').value;
  const charting = document.getElementById('newCharting').value;
  const prescriptions = document.getElementById('newPrescriptions').value.split(',').map(p => p.trim()).filter(p => p);
  const notes = document.getElementById('newNotes').value;

  if (!patient_id) return alert('Select a patient first.');

  try {
    const res = await fetch('/api/integrations?type=clinical', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ patient_id, charting, prescriptions, imaging: [], notes })
    });

    if (!res.ok) throw new Error('Failed to save record.');
    alert('✅ Clinical record saved successfully!');
    closeModal('newRecordModal');
  } catch (err) {
    console.error(err);
    alert(`❌ ${err.message}`);
  }
}

// =============================
// Load patients who have records
// =============================
async function loadRecordsPatientsDropdown() {
  const select = document.getElementById('recordsPatientSelect');
  select.innerHTML = '';
  try {
    const res = await fetch('/api/integrations?type=clinical'); // fetch all records
    const records = await res.json();
    const patientsMap = new Map();

    (records.data || []).forEach(r => {
      if (!patientsMap.has(r.patient_id)) {
        patientsMap.set(r.patient_id, { patient_id: r.patient_id, full_name: r.full_name, age: r.age });
      }
    });

    patientsMap.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.patient_id;
      opt.textContent = `${p.full_name || p.patient_id} (Age: ${p.age || 'N/A'})`;
      select.appendChild(opt);
    });

    select.addEventListener('change', () => {
      loadPatientRecords(select.value);
    });

    // trigger first selection
    if (select.options.length) select.dispatchEvent(new Event('change'));
  } catch (err) {
    console.error('Failed to load records patients:', err);
  }
}

// =============================
// Load all records for a patient
// =============================
let currentPatientRecords = [];

async function loadPatientRecords(patientId) {
  const container = document.getElementById('patientRecordsContainer');
  container.innerHTML = '';
  try {
    const res = await fetch(`/api/integrations?type=clinical&patient_id=${patientId}`);
    const data = await res.json();
    currentPatientRecords = data.data || [];

    if (!currentPatientRecords.length) {
      container.innerHTML = '<p class="text-gray-500">No records found.</p>';
      return;
    }

    currentPatientRecords.forEach((rec, idx) => {
      const div = document.createElement('div');
      div.className = 'border-b py-2';
      div.innerHTML = `
        <strong>Visit ${idx+1} — ${rec.created_at}</strong>
        <p><strong>Diagnosis:</strong> ${rec.diagnosis || 'N/A'}</p>
        <p><strong>Charting:</strong> ${rec.charting || 'N/A'}</p>
        <p><strong>Prescriptions:</strong> ${rec.prescriptions || 'N/A'}</p>
        <p><strong>Notes:</strong> ${rec.notes || 'N/A'}</p>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error('Failed to load patient records:', err);
    container.innerHTML = '<p class="text-red-500">Error loading records.</p>';
  }
}

// =============================
// Export patient records to PDF
// =============================
function exportPatientRecordsPDF() {
  if (!currentPatientRecords.length) return alert('No records to export.');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;

  currentPatientRecords.forEach((r, idx) => {
    doc.text(`Visit ${idx+1} - ${r.created_at}`, 10, y); y+=6;
    doc.text(`Diagnosis: ${r.diagnosis || 'N/A'}`, 10, y); y+=6;
    doc.text(`Charting: ${r.charting || 'N/A'}`, 10, y); y+=6;
    doc.text(`Prescriptions: ${r.prescriptions || 'N/A'}`, 10, y); y+=6;
    doc.text(`Notes: ${r.notes || 'N/A'}`, 10, y); y+=10;
    if (y > 270) { doc.addPage(); y = 10; }
  });

  doc.save('patient_records.pdf');
}
</script>
</body>
</html>

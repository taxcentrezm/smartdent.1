<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartDent ERP — Clinical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
  /* Optional: smooth fade for modal overlay */
  #modalOverlay {
    transition: opacity 0.2s;
  }
</style>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-4; }
    .tab-active { @apply border-b-2 border-indigo-600 text-indigo-600 font-semibold; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 antialiased">

  <!-- Header -->
  <header class="bg-indigo-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v6"></path><path d="M8 10s1 2 4 2 4-2 4-2"></path><path d="M6 21s2-4 6-4 6 4 6 4"></path>
          </svg>
        </div>
        <div class="font-semibold text-lg">SmartDent ERP</div>
      </div>
      <div class="flex items-center gap-3">
        <button class="bg-white/90 text-indigo-600 px-3 py-2 rounded-md inline-flex items-center gap-2 shadow-sm">
          <i data-feather="clipboard"></i> Clinical Tools
        </button>
        <div class="relative">
          <button class="flex items-center gap-2 bg-white/90 px-3 py-2 rounded-full shadow-sm">
            <img src="assets/images/avatar(1).jpg" class="w-8 h-8 rounded-full object-cover">
            <span class="hidden md:inline-block text-sm">Dr._____</span>
            <i data-feather="chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  

  <main class="container mx-auto px-4 py-6">
    <div class="card space-y-4">

    <!-- Buttons -->
<div class="my-4">
  <button id="newRecordBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Add New Clinical Record</button>
  <button id="viewRecordsBtn" class="px-4 py-2 bg-green-600 text-white rounded-md ml-2">View Patient Records</button>
</div>

<div id="modalOverlay" class="fixed inset-0 bg-black/50 hidden z-40"></div>

<!-- 1️⃣ New Clinical Record Modal -->
<div id="newRecordModal" class="fixed inset-0 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg relative">
    <h2 class="text-xl font-semibold mb-4">New Clinical Record</h2>
    <button onclick="closeModal('newRecordModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">&times;</button>
    
    <form id="newRecordForm" class="space-y-3">
      <select id="newPatientSelect" class="w-full border rounded p-2 mb-2">
  <!-- Options populated dynamically from /api/patients -->
</select>

      <label>Patient Name </label>
      <input type="text" id="patientName" placeholder="Patient Name" class="w-full border rounded p-2" required />
      <label>Patient Age</label>
      <input type="number" id="patientAge" placeholder="Age" class="w-full border rounded p-2" required />
      <label>Patient ID</label>
      <input type="text" id="patientId" placeholder="Patient ID" class="w-full border rounded p-2" required />
      <label>Phone Number</label>
      <input type="text" id="patientPhone" placeholder="Phone Number" class="w-full border rounded p-2" />
      <label>Clinic Name</label>
      <input type="text" id="clinicName" placeholder="Clinic Name" class="w-full border rounded p-2" disabled />
      <textarea id="diagnosis" placeholder="Diagnosis" class="w-full border rounded p-2" required></textarea>
      <textarea id="charting" placeholder="Charting Notes" class="w-full border rounded p-2"></textarea>
      <textarea id="notes" placeholder="Additional Notes" class="w-full border rounded p-2"></textarea>
      <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded">Save Record</button>
    </form>
  </div>
</div>


<!-- 2️⃣ View Patient Records Modal -->
<div id="viewRecordsModal" class="fixed inset-0 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl relative max-h-[90vh] overflow-y-auto">
    <h2 class="text-xl font-semibold mb-4">Patient Records</h2>
    <button onclick="closeModal('viewRecordsModal')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">&times;</button>

    <label for="recordsPatientSelect" class="block mb-2 font-medium">Select Patient</label>
    <select id="recordsPatientSelect" class="w-full border rounded p-2 mb-4">
      <!-- Options populated dynamically -->
    </select>

    <div id="patientRecordsContainer" class="space-y-4"></div>

    <button class="px-4 py-2 bg-green-600 text-white rounded-md mt-3" onclick="exportPatientRecordsPDF()">
      Export PDF
    </button>
  </div>
</div>



    
  </div>
</div>
    </div>
  </main>

  <footer class="mt-8 text-sm text-gray-500 text-center">
    SmartDent ERP • Clinical Records & Tools
  </footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const modalOverlay = document.getElementById('modalOverlay');
const newRecordModal = document.getElementById('newRecordModal');
const viewRecordsModal = document.getElementById('viewRecordsModal');
let currentPatientRecords = [];

// ====================
// Utility: Age Calculator
// ====================
function calculateAge(dob) {
  if (!dob) return null;
  const birthDate = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
  return age;
}

// ====================
// Modal Controls
// ====================
function openModal(modalId, loaderFn) {
  modalOverlay.classList.remove('hidden');
  document.getElementById(modalId).classList.remove('hidden');
  if (typeof loaderFn === 'function') loaderFn();
}
function closeModal(modalId) {
  document.getElementById(modalId).classList.add('hidden');
  modalOverlay.classList.add('hidden');
}
modalOverlay.addEventListener('click', () => {
  closeModal('newRecordModal');
  closeModal('viewRecordsModal');
});
document.getElementById('newRecordBtn').addEventListener('click', () => openModal('newRecordModal', loadPatientsDropdown));
document.getElementById('viewRecordsBtn').addEventListener('click', () => openModal('viewRecordsModal', loadRecordsPatientsDropdown));

// ====================
// Load Patients for New Record
// ====================
async function loadPatientsDropdown() {
  const select = document.getElementById('newPatientSelect');
  if (!select) return;
  select.innerHTML = '';
  try {
    const res = await fetch('/api/integrations?type=clinical');
    const data = await res.json();
    const seen = new Set();

    (data.data || []).forEach(p => {
      if (seen.has(p.patient_id)) return;
      seen.add(p.patient_id);

      const opt = document.createElement('option');
      opt.value = p.patient_id;
      opt.textContent = `${p.full_name} (${p.phone})`;
      Object.entries({
        name: p.full_name,
        age: p.age || calculateAge(p.dob) || 'Unknown',
        phone: p.phone || '',
        email: p.email || '',
        gender: p.gender || '',
        dob: p.dob || '',
        clinic: p.clinic_id || 'Clinic'
      }).forEach(([key, val]) => opt.dataset[key] = val);
      select.appendChild(opt);
    });

    select.addEventListener('change', () => {
      const opt = select.selectedOptions[0];
      ['name','age','phone','email','gender','dob','clinic'].forEach(field => {
        document.getElementById(`patient${field.charAt(0).toUpperCase()+field.slice(1)}`).value = opt.dataset[field];
      });
      document.getElementById('patientId').value = opt.value;
    });

    if (select.options.length) select.dispatchEvent(new Event('change'));
  } catch (err) {
    console.error('Failed to load patients:', err);
  }
}

// ====================
// Save New Record
// ====================
document.getElementById('newRecordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    patient_id: document.getElementById('patientId').value.trim(),
    full_name: document.getElementById('patientName').value.trim(),
    dob: document.getElementById('patientDob').value.trim(),
    age: document.getElementById('patientAge').value.trim(),
    gender: document.getElementById('patientGender').value.trim(),
    phone: document.getElementById('patientPhone').value.trim(),
    email: document.getElementById('patientEmail').value.trim(),
    clinic_id: document.getElementById('clinicName').value.trim(),
    diagnosis: document.getElementById('diagnosis').value.trim(),
    charting: document.getElementById('charting').value.trim(),
    prescriptions: [], // Extend with input if needed
    notes: document.getElementById('notes').value.trim()
  };

  if (!payload.patient_id || !payload.full_name || !payload.dob || !payload.clinic_id || !payload.diagnosis) {
    return alert('Patient ID, name, DOB, clinic, and diagnosis are required.');
  }

  try {
    const res = await fetch('/api/integrations?type=clinical', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('Failed to save record.');
    alert('✅ Enriched clinical record saved successfully!');
    closeModal('newRecordModal');
  } catch (err) {
    console.error(err);
    alert(`❌ ${err.message}`);
  }
}

// ====================
// Load Patients with Records
// ====================
async function loadRecordsPatientsDropdown() {
  const select = document.getElementById('recordsPatientSelect');
  if (!select) return;
  select.innerHTML = '';
  try {
    const res = await fetch('/api/integrations?type=clinical');
    const data = await res.json();
    const patientsMap = new Map();

    (data.data || []).forEach(r => {
      if (!patientsMap.has(r.patient_id)) {
        patientsMap.set(r.patient_id, {
          patient_id: r.patient_id,
          full_name: r.full_name || r.patient_id,
          age: r.age || calculateAge(r.dob) || 'Unknown'
        });
      }
    });

    patientsMap.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.patient_id;
      opt.textContent = `${p.full_name} (Age: ${p.age})`;
      select.appendChild(opt);
    });

    select.addEventListener('change', () => {
      loadPatientRecords(select.value);
    });

    if (select.options.length) select.dispatchEvent(new Event('change'));
  } catch (err) {
    console.error('Failed to load records patients:', err);
  }
}

// ====================
// Load Records for Selected Patient
// ====================
async function loadPatientRecords(patientId) {
  const container = document.getElementById('patientRecordsContainer');
  container.innerHTML = '';
  if (!patientId) return;

  try {
    const res = await fetch(`/api/integrations?type=clinical&patient_id=${patientId}`);
    const data = await res.json();
    currentPatientRecords = data.data || [];

    if (!currentPatientRecords.length) {
      container.innerHTML = '<p class="text-gray-500">No records found.</p>';
      return;
    }

    const first = currentPatientRecords[0];
    const name = first.full_name || first.patient_id;
    const age = first.age != null ? first.age : calculateAge(first.dob) || 'Unknown';

    const header = document.createElement('div');
    header.className = 'mb-4 text-lg font-semibold text-indigo-600';
    header.textContent = `Patient: ${name} (Age: ${age})`;
    container.appendChild(header);

    currentPatientRecords.forEach((rec, idx) => {
      const div = document.createElement('div');
      div.className = 'border-b py-2';
      div.innerHTML = `
        <strong>Visit ${idx + 1} — ${rec.created_at}</strong>
        <p><strong>Diagnosis:</strong> ${rec.diagnosis || 'N/A'}</p>
        <p><strong>Charting:</strong> ${rec.charting || 'N/A'}</p>
        <p><strong>Prescriptions:</strong> ${Array.isArray(rec.prescriptions) ? rec.prescriptions.join(', ') : rec.prescriptions || 'N/A'}</p>
        <p><strong>Notes:</strong> ${rec.notes || 'N/A'}</p>
      `;
      container.appendChild(div);
    });
  } catch (err) {
    console.error('Failed to load patient records:', err);
    container.innerHTML = '<p class="text-red-500">Error loading records.</p>';
  }
}

// ====================
// Export PDF
// ====================
function exportPatientRecordsPDF() {
  if (!currentPatientRecords.length) return alert('No records to export.');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;

  const first = currentPatientRecords[0];
  const name = first.full_name || first.patient_id;
  const age = first.age != null ? first.age : calculateAge(first.dob) || 'Unknown';
  const gender = first.gender || 'N/A';
  const phone = first.phone || 'N/A';
  const email = first.email || 'N/A';
  const clinic = first.clinic_id || 'N/A';

  doc.setFontSize(12);
  doc.text(`Patient: ${name}`, 10, y); y += 6;
  doc.text(`Age: ${age}    Gender: ${gender}`, 10, y); y += 6;
  doc.text(`Phone: ${phone}    Email: ${email}`, 10, y); y += 6;
  doc.text(`Clinic: ${clinic}`, 10, y); y += 10;

  currentPatientRecords.forEach((r, idx) => {
    doc.setFontSize(11);
    doc.text(`Visit ${idx + 1} — ${r.created_at}`, 10, y); y += 6;
    doc.text(`Diagnosis: ${r.diagnosis || 'N/A'}`, 10, y); y += 6;
    doc.text(`Charting: ${r.charting || 'N/A'}`, 10, y); y += 6;

    const prescriptions = Array.isArray(r.prescriptions)
      ? r.prescriptions.join(', ')
      : r.prescriptions || 'N/A';
    doc.text(`Prescriptions: ${prescriptions}`, 10, y); y += 6;

    const notes = r.notes || 'N/A';
    const wrappedNotes = doc.splitTextToSize(`Notes: ${notes}`, 180);
    wrappedNotes.forEach(line => {
      doc.text(line, 10, y);
      y += 6;
    });

    y += 8;
    if (y > 270) {
      doc.addPage();
      y = 10;
    }
  });

  const filename = `${name.replace(/\s+/g, '_')}_records.pdf`;
  doc.save(filename);
}
</script>
  
</body>
</html>
